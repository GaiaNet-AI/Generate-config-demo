<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Generate Config Demo</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script type="module" src="component/Selector.js"></script>
    <style>
        .clickButton{
            -webkit-tap-highlight-color: rgba(0,0,0,0);
            outline: none;
            text-decoration: none;
            user-select: none;
            box-shadow: 0 4px 4px rgba(0, 0, 0, 0.25);
        }

        .clickButton:hover {
            filter: contrast(1.02);
        }

        .clickButton:active {
            filter: brightness(0.98);
            transform: scale(0.99);
            box-shadow: 0 2px 2px rgba(0, 0, 0, 0.25);
        }

        .copy:hover {
            filter: contrast(1.02);
        }

        .copy:active {
            filter: brightness(0.98);
            transform: scale(0.9);
        }
    </style>
</head>
<body>
<selector-component id="modelSelector" placeholder="Choose a model to start a magical journey!"
                    mainColor="#000"></selector-component>
<selector-component id="fileSelector" style="margin-top: 1rem;" id="fileSelect" autoSelectFirst="true"
                    placeholder="Select model file" mainColor="#000"></selector-component>
<div style="display: none;margin-top: 1rem;" id="config">
    <div style="display: flex;justify-content: space-between;align-items: center;font-size: 1.5rem;">
        <div>Config:</div>
        <div onclick="saveObjectAsJSON()" style="padding: 0.5rem 1.5rem;border: 1px solid black;border-radius: 0.5rem;" class="clickButton">download config.json</div>
    </div>
    <div style="position: relative;">
        <img onclick="copyJSON()" style="position: absolute;user-select: none;top:1.5rem;right: 1.5rem;" class="copy" id="copyIcon" width="18" height="18" src="./media/Copy.svg"/>
        <pre style="background-color: #f4f4f4;padding: 10px;border-radius: 0.4rem;overflow-x: auto;"
             id="configData"></pre>
    </div>
    <span id="success" style="color: mediumseagreen;display: none;">Copy Success!</span>
    <span id="error" style="color: darkred;display: none;">Copying failed, you can try clicking the download button!</span>
</div>

<script>
    let offset = 0
    let limit = 10
    let configData
    let modelList = []
    let selectedModel

    const modelSelector = document.getElementById("modelSelector");
    const fileSelector = document.getElementById("fileSelector");
    const configPlace = document.getElementById("config");
    const configFilePlace = document.getElementById("configData");

    function getModels() {
        if (modelList.length % limit === 0) {
            fetch(`https://code.flows.network/webhook/DsbnEK45sK3NUzFUyZ9C/models?status=published&trace_status=tracing&order=most_likes&offset=${offset}&limit=${limit}`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.length > 0) {
                        modelList = [...modelList, ...data]
                        modelSelector.list = modelList
                        offset += limit
                    }
                })
                .catch(error => {
                    console.error('There was a problem with the fetch operation:', error);
                });
            return true;
        } else {
            return false;
        }

    }

    modelSelector.queryMore = getModels;

    function selectModel(data) {
        if (data) {
            selectedModel = data;
            fileSelector.disabled = false;
            fileSelector.list = data.files;
        }
    }

    modelSelector.changeCallBack = selectModel;

    function generateConfig(data) {
        if (data) {
            configData = JSON.stringify({
                "description": selectedModel.author.description,
                "public_url": "",
                "chat": data.hf_download_url,
                "prompt_template": selectedModel.prompt_template,
                "reverse_prompt": selectedModel.reverse_prompt,
                "chat_ctx_size": selectedModel.context_size,
                "embedding": "",
                "embedding_ctx_size": "",
                "snapshot": "",
                "domain": "gaianet.xyz",
                "llamaedge_port": "8080"
            }, null, 4)
            configPlace.style.display = "block";
            configFilePlace.innerText = configData;
        }
    }

    fileSelector.disabled = true;
    fileSelector.changeCallBack = generateConfig;

    function copyJSON() {
        navigator.clipboard.writeText(configData).then(function() {
            const success = document.getElementById("success")
            success.style.display = "inline";
            setTimeout(()=>{
                success.style.display = "none";
            },2000)
        }, function(err) {
            const error = document.getElementById("error")
            error.style.display = "inline";
            setTimeout(()=>{
                error.style.display = "none";
            },2000)
            console.log(err)
        });
    }

    function saveObjectAsJSON() {
        const blob = new Blob([configData], {type: 'application/json'});
        const a = document.createElement('a');
        a.style.display = 'none';
        a.download = 'config.json';
        const url = window.URL.createObjectURL(blob);
        a.href = url;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        window.URL.revokeObjectURL(url);
    }
</script>
</body>
</html>